version: "3"
services:

    gitea:
        image: gitea/gitea:1.7.3
        container_name: gitea
        environment:
          - USER_UID=1000
          - USER_GID=1000
        ports:
            - "2222:22"
            - "9090:3000"

        labels:
            - "traefik.frontend.rule=Host:git.local"
            - "traefik.port=3000"
            - "traefik.backend=gitea"
            - "traefik.enable=true"

        volumes:
            - ./data/gitea:/data
            - ./gitea/app.ini:/data/gitea/conf/app.ini

    proxy:
        image: traefik:latest
        container_name: proxy
        command: --api --docker  # Enables the web UI and tells Traefik to listen to docker
        #links:
            #- gitea
            #- drone
        ports:
            - "80:80"     # The HTTP port
            - "443:443"   # The HTTPS port
            - "8080:8080" # The Web UI (enabled by --api)
        labels:
            - "traefik.enable=true"
            - "traefik.frontend.rule=Host:proxy.local"
            #- "traefik.basic.port=8080"
            - "traefik.default.protocol=http"
            - "traefik.port=8080"
            - "traefik.backend=proxy"

        volumes:
            - ./traefik/traefik.toml:/etc/traefik/traefik.toml/:ro
            - ./traefik/certs/:/etc/traefik/certs/:ro
            - /var/run/docker.sock:/var/run/docker.sock

    drone:
        image: drone/drone:1.0.0-rc.5
        container_name: drone
        ports:
            - "9000"
            - "8181:80"
        labels:
            - "traefik.frontend.rule=Host:drone.local"
            - "traefik.port=80"
            - "traefik.backend=drone"
            - "traefik.enable=true"
        depends_on:
            - gitea
        volumes:
            - ./data/drone:/data
        environment:
            - DRONE_OPEN=true
            # The next line needs to point to port 8000
            - DRONE_SERVER_HOST=drone
            #- DRONE_SERVER_PROTO=https
            - DRONE_SERVER_PROTO=http
            - DRONE_RPC_SECRET=ALQU2M0KdptXUdTPKcEw
            - DRONE_ADMIN=sven
            # Gitea Config
            #- DRONE_GITEA=true
            - DRONE_GITEA_SERVER=http://gitea:3000
            - DRONE_GIT_ALWAYS_AUTH=false
            - DRONE_GITEA_SKIP_VERIFY=true
            #- DRONE_DATABASE_DRIVER=sqlite3
            #- DRONE_PROVIDER=gitea
            #- DRONE_NETWORK=ci-network
            - DRONE_LOGS_PRETTY=true
            - DRONE_LOGS_COLOR=true
            - DRONE_DEBUG=true


    drone-agent:
        image: drone/agent:1.0.0-rc.5
        container_name: drone-agent
        depends_on:
            - drone
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        environment:
            - DRONE_RPC_SERVER=http://drone
            - DRONE_RPC_SECRET=ALQU2M0KdptXUdTPKcEw
            - DRONE_RUNNER_CAPACITY=2
            #- DRONE_NETWORK=ci-network
            - DRONE_DEBUG=true
            - DRONE_LOGS_COLOR=true
            - DRONE_RPC_DEBUG=true


# networks:
#   default:
#     external:
#       name: ci-network
